var VueKuzzle=function(e,x){"use strict";function m(e){return(m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t,r,n,i,a,o){try{var u=e[a](o),s=u.value}catch(e){return void r(e)}u.done?t(s):Promise.resolve(s).then(n,i)}function w(u){return function(){var e=this,o=arguments;return new Promise(function(t,r){var n=u.apply(e,o);function i(e){s(n,t,r,i,a,"next",e)}function a(e){s(n,t,r,i,a,"throw",e)}i(void 0)})}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}function k(i){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{},t=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(t=t.concat(Object.getOwnPropertySymbols(a).filter(function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable}))),t.forEach(function(e){var t,r,n;t=i,n=a[r=e],r in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n})}return i}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],0<=t.indexOf(r)||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],0<=t.indexOf(r)||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function f(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function p(e,t,r){return(p="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(r):i.value}})(e,t,r||e)}function v(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var d=function(){function i(e,t,r){var n=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];o(this,i),this.type=null,this.vm=e,this.key=t,this.initialOptions=r,this.options=Object.assign({},r),this._skip=!1,this._watchers=[],this._destroyed=!1,this._loading=!1,e.$data.$kuzzleData&&!e.$data.$kuzzleData.queries[t]&&e.$set(e.$data.$kuzzleData.queries,t,{loading:!1}),this._hasDataField=this.vm.$data.hasOwnProperty(t),this._initData(),n&&this.autostart()}var e,t;return u(i,[{key:"autostart",value:function(){"function"==typeof this.options.skip?this._skipWatcher=this.vm.$watch(this.options.skip.bind(this.vm),this.skipChanged.bind(this),{immediate:!0,deep:this.options.deep}):this.options.skip?this._skip=!0:this.start()}},{key:"skipChanged",value:function(e,t){e!==t&&(this.skip=e)}},{key:"fetchMore",value:function(){}},{key:"refresh",value:(t=w(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._skip){e.next=5;break}return e.next=3,this.stop();case 3:return e.next=5,this.start();case 5:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"start",value:function(){var t=this;if(this.starting=!0,"function"==typeof this.initialOptions.document){var e=this.initialOptions.document.bind(this.vm);this.options.document=e(),this._watchers.push(this.vm.$watch(e,function(e){t.options.document=e,t.refresh()},{deep:this.options.deep}))}if("function"==typeof this.initialOptions.search){var r=this.initialOptions.search.bind(this.vm);this.options.search=r(),this._watchers.push(this.vm.$watch(r,function(e){t.options.search=e,t.refresh()},{deep:this.options.deep}))}return this.executeKuzzle()}},{key:"stop",value:(e=w(regeneratorRuntime.mark(function e(){var t,r,n,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(r=!(t=!0),n=void 0,e.prev=3,i=this._watchers[Symbol.iterator]();!(t=(a=i.next()).done);t=!0)(0,a.value)();e.next=11;break;case 7:e.prev=7,e.t0=e.catch(3),r=!0,n=e.t0;case 11:e.prev=11,e.prev=12,t||null==i.return||i.return();case 14:if(e.prev=14,r)throw n;e.next=17;break;case 17:return e.finish(14);case 18:return e.finish(11);case 19:if(this.sub)return e.next=22,this.client.realtime.unsubscribe(this.sub);e.next=23;break;case 22:this.sub=null;case 23:case"end":return e.stop()}},e,this,[[3,7,11,19],[12,,14,18]])})),function(){return e.apply(this,arguments)})},{key:"executeKuzzle",value:function(){this.starting=!1}},{key:"_initData",value:function(){var e=this;this.options.manual||(this._hasDataField?Object.defineProperty(this.vm.$data.$kuzzleData.data,this.key,{get:function(){return e.vm.$data[e.key]},enumerable:!0,configurable:!0}):Object.defineProperty(this.vm.$data,this.key,{get:function(){return e.vm.$data.$kuzzleData.data[e.key]},enumerable:!0,configurable:!0}))}},{key:"setData",value:function(e){"object"===m(e)&&Object.freeze(e),this.vm.$set(this._hasDataField?this.vm.$data:this.vm.$data.$kuzzleData.data,this.key,e)}},{key:"getData",value:function(){return this._hasDataField?this.vm.$data[this.key]:this.vm.$data.$kuzzleData.data[this.key]}},{key:"callHandlers",value:function(e){for(var t=!1,r=arguments.length,n=new Array(1<r?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];var a=!0,o=!1,u=void 0;try{for(var s,c=e[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var l=s.value;if(l){t=!0;var h=l.apply(this.vm,n);if(void 0!==h&&!h)break}}}catch(e){o=!0,u=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw u}}return t}},{key:"errorHandler",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.callHandlers.apply(this,[[this.options.error,this.vm.$kuzzle.error,this.vm.$kuzzle.provider.errorHandler]].concat(t))}},{key:"catchError",value:function(e){var t;this.errorHandler(e)||(console.error("[vue-kuzzle] An error has occured for ".concat(this.type," '").concat(this.key,"'")),Array.isArray(e)?(t=console).error.apply(t,v(e)):console.error(e))}},{key:"destroy",value:function(){this._destroyed||(this._destroyed=!0,this.stop(),this._skipWatcher&&this._skipWatcher())}},{key:"skip",get:function(){return this._skip},set:function(e){e?this.stop():this.start(),this._skip=e}},{key:"hasMore",get:function(){return!1}},{key:"client",get:function(){var e=this.options.client||"defaultClient";return this.vm.$kuzzle.provider.clients[e]}},{key:"clientSupportsRealtime",get:function(){return void 0===this.client.protocol.http}},{key:"index",get:function(){var e=this.options.index||this.vm.$kuzzle.index||this.vm.$kuzzle.provider.defaultIndex;if(!e)throw new Error("Index was not specified");return e}},{key:"collection",get:function(){var e=this.options.collection||this.vm.$kuzzle.collection||this.vm.$kuzzle.provider.defaultCollection;if(!e)throw new Error("Collection was not specified");return e}},{key:"loading",get:function(){return this.vm.$data.$kuzzleData&&this.vm.$data.$kuzzleData.queries[this.key]?this.vm.$data.$kuzzleData.queries[this.key].loading:this._loading},set:function(e){this._loading!==e&&(this._loading=e,this.vm.$data.$kuzzleData&&this.vm.$data.$kuzzleData.queries[this.key]&&(this.vm.$data.$kuzzleData.queries[this.key].loading=e,this.vm.$data.$kuzzleData.loading+=e?1:-1))}}]),i}();function _(e,t){var r={};for(var n in t)$(t[n],e[n])||(r[n]=t[n]);return r}var z=Array.isArray,g=Object.keys,y=Object.prototype.hasOwnProperty,b=function(e){for(var t=[],r=g(e),n=0;n<r.length;n++){var i=r[n];void 0!==e[i]&&t.push(i)}return t};function $(e,t,r){if(e===t)return!0;if(e&&t&&"object"==m(e)&&"object"==m(t)){var n,i,a,o=z(e),u=z(t);if(o&&u){if((i=e.length)!=t.length)return!1;for(n=i;0!=n--;)if(!$(e[n],t[n],r))return!1;return!0}if(o!=u)return!1;var s=e instanceof Date,c=t instanceof Date;if(s!=c)return!1;if(s&&c)return e.getTime()==t.getTime();var l=e instanceof RegExp,h=t instanceof RegExp;if(l!=h)return!1;if(l&&h)return e.toString()==t.toString();var f=r?b(e):g(e),p=g(t);if((i=f.length)!==p.length)return!1;for(n=i;0!=n--;)if(!y.call(t,f[n]))return!1;for(n=i;0!=n--;)if(!$(e[a=f[n]],t[a],r))return!1;return!0}return e!=e&&t!=t}var R=function(e){function a(e,t,r){var n;(o(this,a),"object"!==m(r))&&(r={document:r});return(n=f(this,l(a).call(this,e,t,r,!1))).type="document",e.$data.$kuzzleData&&!e.$data.$kuzzleData.documents[t]&&e.$set(e.$data.$kuzzleData.documents,t,e.$data.$kuzzleData.queries[t]),n.firstRun=new Promise(function(e,t){n._firstRunResolve=e,n._firstRunReject=t}),n}var t,n,r,i;return c(a,d),u(a,[{key:"executeKuzzle",value:(i=w(regeneratorRuntime.mark(function e(){var t,r,n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.starting=!0,t=this.options,r=t.document,n=t.subscribe,this.setLoading(),e.prev=3,e.next=6,this.vm.$kuzzle.provider.connectAll();case 6:return e.next=8,this.client.document.get(this.index,this.collection,r);case 8:if(i=e.sent)return e.next=12,this.nextResult(i._source,i,"get");e.next=12;break;case 12:this.loadingDone(null,i._source),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(3),this.catchError(e.t0);case 18:if(n)return e.next=21,this.startDocumentSubscription(r);e.next=21;break;case 21:p(l(a.prototype),"executeKuzzle",this).call(this);case 22:case"end":return e.stop()}},e,this,[[3,15]])})),function(){return i.apply(this,arguments)})},{key:"startDocumentSubscription",value:(r=w(regeneratorRuntime.mark(function e(t){var r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.clientSupportsRealtime||this.sub)return e.abrupt("return");e.next=2;break;case 2:return e.prev=2,e.next=5,this.client.realtime.subscribe(this.index,this.collection,{ids:{values:[t]}},function(e){return r.nextResult(e.result._source,e.result,"subscription")},{subscribeToSelf:!1});case 5:this.sub=e.sent,e.next=11;break;case 8:e.prev=8,e.t0=e.catch(2),this.catchError(e.t0);case 11:case"end":return e.stop()}},e,this,[[2,8]])})),function(e){return r.apply(this,arguments)})},{key:"nextResult",value:(n=w(regeneratorRuntime.mark(function e(t,r,n){var i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:if("function"==typeof this.vm.$kuzzle.provider.afterFetch&&(t=this.vm.$kuzzle.provider.afterFetch.call(this.vm,t,r,n)),"function"==typeof this.options.update)return e.next=6,Promise.resolve(this.options.update.call(this.vm,t,r,n));e.next=10;break;case 6:i=e.sent,this.setData(i),e.next=11;break;case 10:this.setData(t);case 11:case"end":return e.stop()}},e,this)})),function(e,t,r){return n.apply(this,arguments)})},{key:"setLoading",value:function(){this.loading||this.applyLoadingModifier(1),this.loading=!0}},{key:"catchError",value:function(e){p(l(a.prototype),"catchError",this).call(this,e),this.loadingDone(e)}},{key:"watchLoading",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.callHandlers.apply(this,[[this.options.watchLoading,this.vm.$kuzzle.watchLoading,this.vm.$kuzzle.provider.watchLoading]].concat(t,[this]))}},{key:"applyLoadingModifier",value:function(e){var t=this.loadingKey;t&&"number"==typeof this.vm[t]&&(this.vm[t]+=e),this.watchLoading(1===e,e)}},{key:"loadingDone",value:function(e,t){this.loading&&this.applyLoadingModifier(-1),this.loading=!1,e?this.firstRunReject(e):(this.changeRun||(this.changeRun=this.firstRun),this.firstRunResolve(t))}},{key:"refetch",value:(t=w(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.setLoading(),e.prev=1,e.next=4,this.client.document.get(this.index,this.collection,this.options.document);case 4:t=e.sent,this.loadingDone(),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),this.catchError(e.t0);case 11:if(t)return e.next=14,this.nextResult(t._source,t,"get");e.next=14;break;case 14:case"end":return e.stop()}},e,this,[[1,8]])})),function(){return t.apply(this,arguments)})},{key:"change",value:function(c){var l=this;if(this.setLoading(),this.changeRun||(this.changeRun=Promise.resolve(null)),"function"==typeof this.options.document){var e=this.options.document.bind(this.vm);this.options.document=e()}var h=this.changeRun=this.changeRun.then(function(){var t=w(regeneratorRuntime.mark(function e(t){var r,n,i,a,o,u,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t&&Object.keys(t).every(function(e){return"_kuzzle_info"===e||c.hasOwnProperty(e)}),n=r?_(t,c):c,i={index:l.index,collection:l.collection,id:l.options.document,documentKey:l.key,savedDocument:t,changedDocument:c},"function"==typeof(a=l.options.beforeChange||l.vm.$kuzzle.beforeChange||l.vm.$kuzzle.provider.beforeChange))return e.prev=5,e.next=8,Promise.resolve(a.call(l.vm,n,i));e.next=15;break;case 8:n=e.sent,e.next=15;break;case 11:return e.prev=11,e.t0=e.catch(5),l.catchError(e.t0),e.abrupt("return",t);case 15:if(n&&0!==Object.keys(n).length){e.next=18;break}return l.loadingDone(),e.abrupt("return",t);case 18:if(e.prev=18,l.options.document){e.next=25;break}return e.next=22,l.client.document.create(l.index,l.collection,n,null,{refresh:"wait_for"});case 22:o=e.sent,e.next=34;break;case 25:if(r){e.next=31;break}return e.next=28,l.client.document.createOrReplace(l.index,l.collection,l.options.document,n,{refresh:"wait_for"});case 28:o=e.sent,e.next=34;break;case 31:return e.next=33,l.client.document.update(l.index,l.collection,l.options.document,n,{refresh:"wait_for"});case 33:o=e.sent;case 34:return e.next=36,l.client.document.get(l.index,l.collection,o._id);case 36:if(u=e.sent._source,s=u,"function"==typeof l.options.update)return e.next=41,Promise.resolve(l.options.update.call(l.vm,u,o,o.created?"created":o.result));e.next=42;break;case 41:s=e.sent;case 42:return l.changeRun===h&&l.setData(s),l.loadingDone(),e.abrupt("return",u);case 47:return e.prev=47,e.t1=e.catch(18),l.catchError(e.t1),e.abrupt("return",t);case 51:case"end":return e.stop()}},e,null,[[5,11],[18,47]])}));return function(e){return t.apply(this,arguments)}}());return h.then(function(){return l.getData()})}},{key:"_initData",value:function(){var t=this;this.options.manual||(this._hasDataField?Object.defineProperty(this.vm.$data.$kuzzleData.data,this.key,{get:function(){return t.vm.$data[t.key]},set:function(e){return t.change(e)},enumerable:!0,configurable:!0}):Object.defineProperty(this.vm.$data,this.key,{get:function(){return t.vm.$data.$kuzzleData.data[t.key]},set:function(e){return t.change(e)},enumerable:!0,configurable:!0}))}},{key:"firstRunResolve",value:function(e){this._firstRunResolve&&(this._firstRunResolve(e),this._firstRunResolve=null)}},{key:"firstRunReject",value:function(e){this._firstRunReject&&(this._firstRunReject(e),this._firstRunReject=null)}},{key:"destroy",value:function(){p(l(a.prototype),"destroy",this).call(this),this.loading&&this.watchLoading(!1,-1),this.loading=!1}},{key:"loadingKey",get:function(){return this.options.loadingKey||this.vm.$kuzzle.loadingKey}}]),a}(),D=function(e){function i(e,t,r){var n;return o(this,i),(n=f(this,l(i).call(this,e,t,r,!1))).type="search",n}var t,r;return c(i,d),u(i,[{key:"executeKuzzle",value:(r=w(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.options.search,e.prev=1,e.next=4,this.vm.$kuzzle.provider.connectAll();case 4:return e.next=6,this.client.document.search(this.index,this.collection,{query:t.query,aggregations:t.aggregations,sort:t.sort},{from:t.from||0,size:t.size||10});case 6:this.response=e.sent,r=this.response.hits.map(function(e){return e._source}),r=this.applyAfterFetch(r,this.response),this.nextResult(r,this.response),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(1),this.catchError(e.t0);case 15:p(l(i.prototype),"executeKuzzle",this).call(this);case 16:case"end":return e.stop()}},e,this,[[1,12]])})),function(){return r.apply(this,arguments)})},{key:"fetchMore",value:(t=w(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.response){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.response.next();case 5:t=e.sent,(r=t.hits.map(function(e){return e._source}))&&(r=this.applyAfterFetch(r,t),n=[].concat(v(this.getData()),v(r)),this.nextResult(n,t)),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),this.catchError(e.t0);case 13:case"end":return e.stop()}},e,this,[[2,10]])})),function(){return t.apply(this,arguments)})},{key:"nextResult",value:function(e,t){"function"==typeof this.options.update?this.setData(this.options.update.call(this.vm,e,t)):this.setData(e)}},{key:"applyAfterFetch",value:function(e,t){return"function"!=typeof this.vm.$kuzzle.provider.afterFetch?e:this.vm.$kuzzle.provider.afterFetch.call(this.vm,e,t,"search")}},{key:"hasMore",get:function(){return!!this.response&&this.response.fetched<this.response.total}}]),i}(),i=function(){function t(e){o(this,t),this._kuzzleSubscriptions=[],this._watchers=[],this.vm=e,this.queries={},this.documents={},this.searches={},this.client=void 0,this.loadingKey=void 0,this.error=void 0}var n,r,i,a;return u(t,[{key:"getClient",value:function(e){if(!e||!e.client){if("object"===m(this.client))return this.client;if(this.client){if(this.provider.clients){var t=this.provider.clients[this.client];if(!t)throw new Error("[vue-kuzzle] Missing client '".concat(this.client,"' in 'kuzzleProvider'"));return t}throw new Error("[vue-kuzzle] Missing 'clients' options in 'kuzzleProvider'")}return this.provider.defaultClient}var r=this.provider.clients[e.client];if(!r)throw new Error("[vue-kuzzle] Missing client '".concat(e.client,"' in 'kuzzleProvider'"));return r}},{key:"query",value:function(e,t){var r=this.getIndexAndCollection(t),n=r.index,i=r.collection;try{return this.getClient(t).query({index:n,collection:i,controller:t.controller,action:t.action,_id:t.id,body:e,refresh:"wait_for"})}catch(e){throw new Error("[vue-kuzzle] ".concat(e))}}},{key:"get",value:(a=w(regeneratorRuntime.mark(function e(t,r){var n,i,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.getIndexAndCollection(r,"getDocument"),i=n.index,a=n.collection,e.next=3,this.getClient(r).document.get(i,a,t);case 3:return o=e.sent,e.abrupt("return",k({},this.applyAfterFetch(o._source,o,"get"),{_kuzzle_response:o}));case 5:case"end":return e.stop()}},e,this)})),function(e,t){return a.apply(this,arguments)})},{key:"search",value:(i=w(regeneratorRuntime.mark(function e(t,r){var n,i,a,o,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.getIndexAndCollection(r,"searchDocuments"),i=n.index,a=n.collection,e.next=3,this.getClient(r).document.search(i,a,{query:t,aggregations:r&&r.aggregations,sort:r&&r.sort},{from:r&&r.from||0,size:r&&r.size||10});case 3:return o=e.sent,u=(o.hits||[]).map(function(e){return e._source}),(u=this.applyAfterFetch(u,o,"search"))._kuzzle_response=o,e.abrupt("return",u);case 8:case"end":return e.stop()}},e,this)})),function(e,t){return i.apply(this,arguments)})},{key:"create",value:(r=w(regeneratorRuntime.mark(function e(t,r){var n,i,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.getIndexAndCollection(r,"createDocument"),i=n.index,a=n.collection,!r||!0!==r.replace){e.next=7;break}if(r.id){e.next=4;break}throw new Error("[vue-kuzzle] Missing 'id' in 'createDocument' called with 'replace: true'");case 4:return e.next=6,this.getClient(r).document.createOrReplace(i,a,r&&r.id,t,{refresh:"wait_for"});case 6:o=e.sent;case 7:return e.next=9,this.getClient(r).document.create(i,a,t,r&&r.id,{refresh:"wait_for"});case 9:return o=e.sent,e.abrupt("return",k({},this.applyAfterFetch(o._source,o,o.created?"create":o.result),{_kuzzle_response:o}));case 11:case"end":return e.stop()}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"change",value:(n=w(regeneratorRuntime.mark(function e(t,r,n){var i,a,o,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.getIndexAndCollection(n,"changeDocument"),a=i.index,o=i.collection,n&&!0===n.replace)return e.next=4,this.getClient(n).document.replace(a,o,t,r,{refresh:"wait_for"});e.next=5;break;case 4:u=e.sent;case 5:return e.next=7,this.getClient(n).document.update(a,o,t,r,{refresh:"wait_for"});case 7:return u=e.sent,e.abrupt("return",k({},this.applyAfterFetch(u._source,u,u.response),{_kuzzle_response:u}));case 9:case"end":return e.stop()}},e,this)})),function(e,t,r){return n.apply(this,arguments)})},{key:"delete",value:function(e,t){var r=this.getIndexAndCollection(t,"deleteDocument"),n=r.index,i=r.collection;return this.getClient(t).document.delete(n,i,e,{refresh:"wait_for"})}},{key:"addSmartDocumentOrSearch",value:function(e,t){var r,n=function(e,t){for(;"function"==typeof e;)e=e.call(t);return e}(t,this.vm);if(void 0!==n.document)r=this.queries[e]=this.documents[e]=new R(this.vm,e,n,!1);else{if("undefined"===n.search)throw new Error("[vue-kuzzle] Missing either 'document' or 'search' in 'kuzzle.".concat(e,"' options"));r=this.queries[e]=this.searches[e]=new D(this.vm,e,n,!1)}return this.vm.$isServer||r.autostart(),r}},{key:"applyAfterFetch",value:function(e,t,r){return"function"!=typeof this.provider.afterFetch?e:this.provider.afterFetch.call(this.vm,e,t,r)}},{key:"defineReactiveSetter",value:function(t,e,r){var n=this;this._watchers.push(this.vm.$watch(e,function(e){n[t]=e},{immediate:!0,deep:r}))}},{key:"getIndexAndCollection",value:function(e,t){var r=e&&e.index||this.index||this.provider.defaultIndex,n=e&&e.collection||this.collection||this.provider.defaultCollection;if(t){if(!r)throw new Error("[vue-kuzzle] Missing index in '".concat(t,"'"));if(!n)throw new Error("[vue-kuzzle] Missing collection in '".concat(t,"'"))}return{index:r,collection:n}}},{key:"destroy",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._watchers[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){(0,n.value)()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}for(var a in this.queries)this.queries[a].destroy();this.vm=null}},{key:"provider",get:function(){return this.vm.$kuzzleProvider}},{key:"loading",get:function(){return 0!==this.vm.$data.$kuzzleData.loading}},{key:"data",get:function(){return this.vm.$data.$kuzzleData.data}}]),t}(),t=function(){function t(e){if(o(this,t),!e)throw new Error("Options argument required");this.clients=e.clients||{},this.clients.defaultClient=this.defaultClient=e.defaultClient,this.defaultOptions=e.defaultOptions||{},this.defaultIndex=e.defaultIndex,this.defaultCollection=e.defaultCollection,this.watchLoading=e.watchLoading,this.errorHandler=e.errorHandler,this.beforeChange=e.beforeChange,this.afterFetch=e.afterFetch,this.connectAll()}return u(t,[{key:"connectAll",value:function(){return this._connectAllPromise||(this._connectAllPromise=Promise.all(Object.values(this.clients).map(function(e){return e.connect()}))),this._connectAllPromise}}]),t}();function a(e,t){return void 0!==e&&Object.prototype.hasOwnProperty.call(e,t)}function O(){var e=this.$options,t=e.kuzzleProvider;t?this.$kuzzleProvider="function"==typeof t?t():t:e.parent&&e.parent.$kuzzleProvider&&(this.$kuzzleProvider=e.parent.$kuzzleProvider)}function P(){var e=this,t=this.$kuzzleProvider;if(!this._kuzzleLaunched&&t){this._kuzzleLaunched=!0;var r=this.$options.kuzzle;if(r)for(var n in this.$_kuzzlePromises=[],r.$init||(r.$init=!0,t.defaultOptions&&(r=this.$options.kuzzle=Object.assign({},t.defaultOptions,r))),j(this.$kuzzle,"client",r.$client,r.$deep),j(self.$kuzzle,"index",r.$index,r.$deep),j(self.$kuzzle,"collection",r.$collection,r.$deep),j(this.$kuzzle,"loadingKey",r.$loadingKey,r.$deep),j(this.$kuzzle,"error",r.$error,r.$deep),j(this.$kuzzle,"watchLoading",r.$watchLoading,r.$deep),Object.defineProperty(this,"$kuzzleData",{get:function(){return e.$data.$kuzzleData},enumerable:!0,configurable:!0}),r)if("$"!==n.charAt(0)){var i=r[n],a=this.$kuzzle.addSmartDocumentOrSearch(n,i);!1!==i.prefetch&&!1!==r.$prefetch&&this.$_kuzzlePromises.push(a.firstRun)}}}function j(e,t,r,n){void 0!==r&&("function"==typeof r?e.defineReactiveSetter(t,r,n):e[t]=r)}function C(){this.$_kuzzle&&(this.$_kuzzle.destroy(),this.$_kuzzle=null)}function A(e,t){e.mixin(k({},"1"===t?{init:O}:{},"2"===t?{data:function(){return{$kuzzleData:{queries:{},documents:{},searches:{},loading:0,data:this.$_kuzzleInitData}}},beforeCreate:function(){O.call(this),function(){var r=this;this.$_kuzzleInitData={};var e=this.$options.kuzzle;if(e){var t=function(t){"$"!==t.charAt(0)&&(e[t].manual||a(r.$options.props,t)||a(r.$options.computed,t)||a(r.$options.methods,t)||Object.defineProperty(r,t,{get:function(){return r.$data.$kuzzleData.data[t]},set:function(e){return r.$_kuzzleInitData[t]=e},enumerable:!0,configurable:!0}))};for(var n in e)t(n)}}.call(this)},serverPrefetch:function(){if(this.$_kuzzlePromises)return Promise.all(this.$_kuzzlePromises)}}:{},{created:P,destroyed:C}))}var E=Symbol("kuzzleProvider");function S(n){var e=n&&n.provider,t=q(e,n);if(t)return t;var i=e||x.inject(E).value;if(!i)throw new Error("[useKuzzle] Missing 'kuzzleProvider' to be provided via 'provide'");if(e){var r=q(i,n);if(r)return L(null,n,r),r}var a=i.defaultIndex,o=i.defaultCollection,s=function(e){if(e&&e.client){if("object"===m(e.client))return e.client;if(i.clients){var t=i.clients[e.client];if(!t)throw new Error("[useKuzzle] Missing client '".concat(e.client,"' in 'kuzzleProvider'"));return t}throw new Error("[useKuzzle] Missing 'clients' options in 'kuzzleProvider'")}if(!n||!n.client)return i.defaultClient;var r=i.clients[n.client];if(!r)throw new Error("[useKuzzle] Missing client '".concat(n.client,"' in 'kuzzleProvider'"));return r},c=function(e,t){var r=e&&e.index||a,n=e&&e.collection||o;if(t){if(!r)throw new Error("[useKuzzle] Missing index in '".concat(t,"'"));if(!n)throw new Error("[useKuzzle] Missing collection in '".concat(t,"'"))}return{index:r,collection:n}},l="function"==typeof i.afterFetch?i.afterFetch:function(e){return e},u=function(){var r=w(regeneratorRuntime.mark(function e(t,r){var n,i,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c(r,"getDocument"),i=n.index,a=n.collection,e.next=3,s(r).document.get(i,a,t);case 3:return o=e.sent,e.abrupt("return",k({},l.call(null,o._source,o,"get"),{_kuzzle_response:o}));case 5:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}(),h=function(){var r=w(regeneratorRuntime.mark(function e(t,r){var n,i,a,o,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c(r,"searchDocuments"),i=n.index,a=n.collection,e.next=3,s(r).document.search(i,a,{query:t,aggregations:r&&r.aggregations,sort:r&&r.sort},{from:r&&r.from||0,size:r&&r.size||10});case 3:return o=e.sent,u=(o.hits||[]).map(function(e){return e._source}),(u=l.call(null,u,o,"search"))._kuzzle_response=o,e.abrupt("return",u);case 8:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}(),f=function(){var t=w(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return void 0!==t._kuzzle_response&&(t=t._kuzzle_response),e.next=3,t.next();case 3:if(r=e.sent){e.next=6;break}return e.abrupt("return",[]);case 6:return n=r.hits.map(function(e){return e._source}),n=l.call(null,n,t,"search"),e.abrupt("return",n);case 9:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),p=function(){var r=w(regeneratorRuntime.mark(function e(t,r){var n,i,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=c(r,"createDocument"),i=n.index,a=n.collection,!r||!0!==r.replace){e.next=7;break}if(r.id){e.next=4;break}throw new Error("[vue-kuzzle] Missing 'id' in 'createDocument' called with 'replace: true'");case 4:return e.next=6,s(r).document.createOrReplace(i,a,r&&r.id,t,{refresh:"wait_for"});case 6:o=e.sent;case 7:return e.next=9,s(r).document.create(i,a,t,r&&r.id,{refresh:"wait_for"});case 9:return o=e.sent,e.abrupt("return",k({},l.call(null,o._source,o,o.created?"create":o.result),{_kuzzle_response:o}));case 11:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}(),d=function(){var n=w(regeneratorRuntime.mark(function e(t,r,n){var i,a,o,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=c(n,"changeDocument"),a=i.index,o=i.collection,n&&!0===n.replace)return e.next=4,s(n).document.replace(a,o,t,r,{refresh:"wait_for"});e.next=5;break;case 4:u=e.sent;case 5:return e.next=7,s(n).document.update(a,o,t,r,{refresh:"wait_for"});case 7:return u=e.sent,e.abrupt("return",k({},l.call(null,u._source,u,u.response),{_kuzzle_response:u}));case 9:case"end":return e.stop()}},e)}));return function(e,t,r){return n.apply(this,arguments)}}(),v={provider:i,getClient:s,query:function(e,t){var r=c(t),n=r.index,i=r.collection;try{return s(t).query({index:n,collection:i,controller:t.controller,action:t.action,_id:t.id,body:e,refresh:"wait_for"})}catch(e){throw new Error("[useKuzzle] ".concat(e))}},get:u,search:h,fetchMore:f,create:p,change:d,delete:function(e,t){var r=c(t,"deleteDocument"),n=r.index,i=r.collection;return s(t).document.delete(n,i,e,{refresh:"wait_for"})},getIndexAndCollection:c};return L(e,n,v),v}var K=new Map,M=function(e){return e||"default"},F=function(e){var t=null;return e&&(t=e.client||"default"),t||"default"};function q(e,t){var r=M(e),n=K.get(r);return n?n[F(t)]:null}function L(e,t,r){var n=M(e),i=K.get(n);i||(i={}),i[F(t)]=r,K.set(n,i)}function I(e,t){if(!I.installed){I.installed=!0;var r=e.version.substr(0,e.version.indexOf("."));Object.defineProperty(e.prototype,"$kuzzle",{get:function(){return this.$_kuzzle||(this.$_kuzzle=new i(this)),this.$_kuzzle}}),A(e,r)}}t.install=I;var H=t,T=null;return"undefined"!=typeof window?T=window.Vue:"undefined"!=typeof global&&(T=global.Vue),T&&T.use(t),e.install=I,e.KuzzleProvider=H,e.default=t,e.KUZZLE_PROVIDER_KEY=E,e.useKuzzle=S,e.fetchKuzzle=function(v){if(!v||!v.document)throw new Error("[fetchKuzzle] Missing `document` in options");var m,k=S(v),a=x.value(!1),z=x.value(!1),g=x.value(null),t=x.value(null),y="function"==typeof v.document?x.computed(v.document):x.value(v.document),e="function"==typeof v.skip?x.computed(v.skip):x.value(v.skip),b=function(e){t.value=e,a.value=!1,z.value=!1,"function"==typeof v.error?v.error(e):console.error(e)};x.watch(function(){return e.value?null:y.value},(r=w(regeneratorRuntime.mark(function e(t){var r,n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return a.value=!0,e.next=5,k.provider.connectAll();case 5:return e.prev=5,e.next=8,k.get(t,v);case 8:r=e.sent,n=r._kuzzle_response,i=h(r,["_kuzzle_response"]),a.value=!1,v.update?g.value=v.update(i,n):g.value=i,m||(m=Promise.resolve(g.value)),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(5),b(e.t0);case 19:case"end":return e.stop()}},e,null,[[5,16]])})),function(e){return r.apply(this,arguments)}),{lazy:!1});var r;var n=(u=w(regeneratorRuntime.mark(function e(p){var d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return z.value=!0,m||(m=Promise.resolve(null)),d=m=m.then(function(){var t=w(regeneratorRuntime.mark(function e(t){var r,n,i,a,o,u,s,c,l,h,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t&&Object.keys(t).every(function(e){return"_kuzzle_info"===e||p.hasOwnProperty(e)}),n=r?_(t,p):p,i=k.getIndexAndCollection(v,"change"),a=i.index,o=i.collection,u={kuzzle:k,index:a,collection:o,id:y.value,savedDocument:t,changedDocument:p},"function"==typeof(s=v.beforeChange||k.provider.beforeChange))return e.prev=6,e.next=9,Promise.resolve(s.call(null,n,u));e.next=16;break;case 9:n=e.sent,e.next=16;break;case 12:return e.prev=12,e.t0=e.catch(6),b(e.t0),e.abrupt("return",t);case 16:if(n&&0!==Object.keys(n).length){e.next=19;break}return z.value=!1,e.abrupt("return",t);case 19:if(c=k.getClient(v),e.prev=20,y.value){e.next=27;break}return e.next=24,c.document.create(a,o,n,null,{refresh:"wait_for"});case 24:l=e.sent,e.next=36;break;case 27:if(r){e.next=33;break}return e.next=30,c.document.createOrReplace(a,o,y.value,n,{refresh:"wait_for"});case 30:l=e.sent,e.next=36;break;case 33:return e.next=35,c.document.update(a,o,y.value,n,{refresh:"wait_for"});case 35:l=e.sent;case 36:return e.next=38,c.document.get(a,o,l._id);case 38:if(h=e.sent._source,f=h,"function"==typeof v.update)return e.next=43,Promise.resolve(v.update(h,l,l.created?"created":l.result));e.next=44;break;case 43:f=e.sent;case 44:return m===d&&(g.value=f),z.value=!1,e.abrupt("return",f);case 49:return e.prev=49,e.t1=e.catch(20),b(e.t1),e.abrupt("return",t);case 53:case"end":return e.stop()}},e,null,[[6,12],[20,49]])}));return function(e){return t.apply(this,arguments)}}()),e.abrupt("return",d.then(function(){return g.value}));case 4:case"end":return e.stop()}},e)})),function(e){return u.apply(this,arguments)}),i=x.computed(function(){return a.value||z.value}),o=x.computed(function(){return g.value},n);var u;return{kuzzle:k,isReading:a,isWriting:z,isLoading:i,data:o,error:t,change:n}},e.searchKuzzle=function(n){if(!n||!n.search)throw new Error("[searchKuzzle] Missing `search` in options");var i=S(n),a=x.value(!1),r=x.value(null),t=x.value(null),o=x.value(null),e="function"==typeof n.search?x.computed(n.search):x.value(n.search),u="function"==typeof n.skip?x.computed(n.skip):x.value(n.skip),s=function(e,t){o.value=t,n.update?r.value=n.update(e,t):r.value=e},c=function(e){t.value=e,a.value=!1,"function"==typeof n.error?n.error(e):console.error(e)},l=(h=w(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return a.value=!0,e.next=5,i.provider.connectAll();case 5:return e.prev=5,e.next=8,i.search(t.query||{},k({},n,{aggregations:t.aggregations,sort:t.sort,from:t.from,size:t.size}));case 8:r=e.sent,a.value=!1,s(r,r._kuzzle_response),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(5),c(e.t0);case 16:case"end":return e.stop()}},e,null,[[5,13]])})),function(e){return h.apply(this,arguments)});var h;x.watch(function(){return u.value?null:e.value},l,{lazy:!1});var f=x.computed(function(){return!!o.value&&o.value.fetched<o.value.total}),p=(d=w(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o.value){e.next=2;break}return e.abrupt("return");case 2:return a.value=!0,e.prev=3,e.next=6,i.fetchMore(o.value);case 6:return t=e.sent,s([].concat(v(r.value),v(t)),o.value),e.abrupt("return",t);case 11:e.prev=11,e.t0=e.catch(3),c(e.t0);case 14:case"end":return e.stop()}},e,null,[[3,11]])})),function(){return d.apply(this,arguments)});var d;return{kuzzle:i,isLoading:a,data:r,error:t,hasMore:f,fetchMore:p,refresh:function(){return l(e.value)}}},e}({},vueFunctionApi);
